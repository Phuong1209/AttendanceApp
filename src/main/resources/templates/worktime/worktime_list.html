<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>勤務時間管理</title>
    <style>
        .weekend {
            background-color: lightblue !important;
        }
        .future {
            background-color: lightgray !important;
        }
        .null-data {
            color: red;
        }
        .btn-blue {
            background-color: blue;
            color: white;
        }
        .btn-green {
            background-color: green;
            color: white;
        }
        .btn-red {
            background-color: red;
            color: white;
        }
    </style>
    <link rel="stylesheet" href="/css/style.css"> <!-- Link to the style.css -->
    <script>
        function parseTimeString(timeStr) {
            if (!timeStr || !timeStr.includes(":")) return null;
            const [hours, minutes] = timeStr.split(":").map(Number);
            return new Date(1970, 0, 1, hours, minutes, 0);
        }

        function calculateWorkAndOverTime(checkin, checkout, breakTime) {
            const checkinTime = parseTimeString(checkin);
            const checkoutTime = parseTimeString(checkout);
            const breakTimeHours = parseFloat(breakTime) || 0;

            if (!checkinTime || !checkoutTime) {
                return { workTime: '0', overTime: '0' };
            }

            const totalHours = (checkoutTime - checkinTime) / (1000 * 60 * 60) - breakTimeHours;
            const regularWorkTime = Math.max(0, Math.min(totalHours, 8));
            const overTime = Math.max(0, totalHours - 8);

            return { workTime: regularWorkTime.toFixed(2), overTime: overTime.toFixed(2) };
        }

        function updateWorkTimeTable() {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const checkin = row.querySelector('.checkin')?.innerText.trim() || "";
                const checkout = row.querySelector('.checkout')?.innerText.trim() || "";
                const breakTime = row.querySelector('.break')?.innerText.trim() || "0";

                const { workTime, overTime } = calculateWorkAndOverTime(checkin, checkout, breakTime);

                const worktimeCell = row.querySelector('.worktime');
                const overtimeCell = row.querySelector('.overtime');

                worktimeCell.innerText = workTime;
                overtimeCell.innerText = overTime;

                if (workTime === '0' && !checkin && !checkout) {
                    worktimeCell.classList.add('null-data');
                    overtimeCell.classList.add('null-data');
                } else {
                    worktimeCell.classList.remove('null-data');
                    overtimeCell.classList.remove('null-data');
                }

                const button = row.querySelector('.action-btn');
                if (checkin && checkout) {
                    button.textContent = '修正';
                    button.className = 'action-btn btn-blue';
                } else {
                    button.textContent = '登録';
                    button.className = 'action-btn btn-green';
                }

                const deleteButton = row.querySelector('.delete-btn');
                if (deleteButton) {
                    deleteButton.className = 'delete-btn btn-red';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', updateWorkTimeTable);
    </script>
</head>
<body>
<div class="wrapper">
    <div th:replace="~{layout :: sidebar}"></div>
    <div th:replace="~{layout :: top_menu}"></div>
    <div class="main_container">
        <h1>勤務時間管理</h1>
        <h3>ユーザー名: <span th:text="${userFullName}"></span></h3>
        <h4 th:text="${currentYear} + '年' + ${currentMonth} + '月'"></h4>
        <a class="btn-blue" href="http://localhost:8080/worktimes/create">新規作成</a>
        <div style="overflow-x:auto;">
            <table class="list-table">
                <thead>
                <tr>
                    <th>日付</th>
                    <th>曜日</th>
                    <th>出勤</th>
                    <th>退勤</th>
                    <th>休憩</th>
                    <th>時間内</th>
                    <th>残業時間</th>
                    <th>アクション</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="workTime : ${workTimes}"
                    th:classappend="(${workTime.isWeekend} ? 'weekend' : '') + ' ' + (${workTime.isFuture} ? 'future' : '')">
                    <td th:text="${workTime.date}"></td>
                    <td th:text="${workTime.weekday}"></td>
                    <td class="checkin" th:text="${#temporals.format(workTime.checkinTime, 'HH:mm')}"></td>
                    <td class="checkout" th:text="${#temporals.format(workTime.checkoutTime, 'HH:mm')}"></td>
                    <td class="break" th:text="${workTime.breakTime != null ? workTime.breakTime : '0'}"></td>
                    <td class="worktime"></td> <!-- Will be populated by JS -->
                    <td class="overtime"></td> <!-- Will be populated by JS -->
                    <td>
                        <button type="button" class="action-btn"></button>
                        <button type="button" class="delete-btn" th:text="'削除'"></button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
</html>
